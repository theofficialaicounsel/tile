<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ai-Ncards</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/responsivevoice@1.0.0/responsivevoice.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #c41e3a;
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #f5f5f5;
            --border: #333;
            --radius: 12px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: background 0.3s, color 0.3s; }

        /* Header */
        #topBar { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid var(--border); background: var(--bg); z-index: 10; }
        #brandName { font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; cursor: pointer; font-size: 12px; }
        .btn-icon { background: rgba(128, 128, 128, 0.1); border: 1px solid var(--border); color: var(--text); width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 5px; }
        .btn-icon:hover { background: rgba(128, 128, 128, 0.2); }

        /* Selection Bar */
        #selectionBar { background: var(--primary); color: white; display: none; justify-content: space-between; align-items: center; padding: 5px 10px; height: 40px; font-size: 13px; font-weight: bold; }
        #selectionBar .actions button { background: rgba(0, 0, 0, 0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 5px; cursor: pointer; }
        #selectionBar .actions button.danger { background: #b71c1c; }

        /* Main Grid */
        #grid {
            flex: 1; overflow-y: auto; padding: 15px; 
            display: grid; gap: 15px; align-content: start; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            scroll-behavior: smooth; 
        }
        body.view-list #grid { grid-template-columns: 1fr; }

        /* Card */
        .flip-card {
            background-color: var(--card-bg);
            height: 220px;
            perspective: 1000px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            cursor: pointer;
            position: relative;
            display: flex; flex-direction: column;
            transition: transform 0.2s;
        }
        .flip-card-inner {
            position: relative; width: 100%; height: 100%;
            text-align: left; transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            overflow: hidden; display: flex; flex-direction: column;
            border-radius: var(--radius); padding: 0;
        }
        .front { background: linear-gradient(145deg, var(--card-bg), var(--bg)); }
        .back { background: linear-gradient(145deg, var(--bg), var(--card-bg)); transform: rotateY(180deg); }

        .card-header {
            padding: 8px 12px; font-size: 10px; text-transform: uppercase; color: #888;
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;
            background: rgba(0,0,0,0.1); height: 22px; align-items: center;
        }
        .card-content {
            padding: 10px; font-size: 14px; line-height: 1.4; overflow-y: auto; flex: 1; white-space: pre-wrap; font-weight: 500; word-break: break-word;
        }
        .back .card-content { font-family: monospace; font-size: 13px; }
        .card-actions i { opacity: 0.6; margin-left: 6px; cursor: pointer; transition: 0.2s; font-size: 11px; }
        .card-actions i:hover { opacity: 1; color: var(--primary); }

        /* Input */
        #inputPanel { padding: 10px; background: var(--bg); border-top: 1px solid var(--border); display: flex; gap: 8px; align-items: center; padding-bottom: calc(10px + var(--safe-area-bottom)); }
        #userInput { flex: 1; background: rgba(128, 128, 128, 0.1); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 20px; height: 40px; outline: none; }
        #userInput:focus { border-color: var(--primary); }
        #sendBtn { background: var(--primary); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* Menu */
        #cardMenu { position: fixed; display: none; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; z-index: 1000; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); min-width: 160px; overflow: hidden; }
        #cardMenu button { display: block; width: 100%; background: none; border: none; color: var(--text); padding: 10px 15px; text-align: left; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); }
        #cardMenu button:hover { background: rgba(128, 128, 128, 0.1); }
        #cardMenu button:last-child { border-bottom: none; color: #ff6b6b; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal { background: var(--card-bg); width: 90%; max-width: 500px; max-height: 80vh; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5); }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border); text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .modal input[type="text"], .modal textarea { width: 100%; background: rgba(128, 128, 128, 0.1); border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; margin-bottom: 10px; font-family: inherit; }
        .modal textarea { min-height: 100px; resize: vertical; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: rgba(128, 128, 128, 0.2); color: var(--text); border: 1px solid var(--border); }
        
        /* Settings */
        .setting-row { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .setting-row label { display: block; margin-bottom: 5px; color: #888; font-size: 12px; text-transform: uppercase; }
        .toggle-group { display: flex; gap: 5px; flex-wrap: wrap; }
        .toggle-btn { background: rgba(128, 128, 128, 0.1); border: 1px solid var(--border); color: var(--text); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-danger { background: #b71c1c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }

        /* Fullscreen */
        #fullscreenOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 3000; display: none; flex-direction: column; }
        #fsContent { flex: 1; overflow-y: auto; padding: 20px; font-size: 18px; line-height: 1.6; scroll-behavior: smooth; }
        #fsHeader { padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; background: var(--card-bg); }

        /* Toast */
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; opacity: 0; transition: 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; bottom: 90px; }

        /* Streaming */
        .cursor { display: inline-block; width: 2px; height: 1em; background: var(--primary); animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }
        .stop-btn { background: #b71c1c; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; margin-left: 5px; }

        @media (max-width: 600px) {
            #grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>

    <div id="topBar">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div id="brandName">ai-Ncards</div>
            <button class="btn-icon" id="undoBtn" title="Undo"><i class="fas fa-undo"></i></button>
        </div>
        <div>
            <button class="btn-icon" id="settingsBtn" title="Settings"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div id="selectionBar">
        <div id="selectCount">0</div>
        <div class="actions">
            <button onclick="app.bulkMerge()">Merge</button>
            <button onclick="app.clearSelection()">Cancel</button>
            <button class="danger" onclick="app.bulkDelete()">Delete</button>
        </div>
    </div>

    <div id="grid"></div>

    <div id="inputPanel">
        <input type="text" id="userInput" placeholder="Type to create..." autocomplete="off">
        <button id="sendBtn"><i class="fas fa-arrow-up"></i></button>
    </div>

    <div id="cardMenu">
        <button data-act="continue">Continue / Refine</button>
        <button data-act="ai-edit">Magic Action (AI)</button>
        <button data-act="style">Style</button>
        <button data-act="copy">Copy</button>
        <button data-act="fs">Fullscreen</button>
        <button data-act="delete">Delete</button>
    </div>

    <div id="fullscreenOverlay">
        <div id="fsHeader">
            <div>
                <button class="btn btn-secondary" onclick="app.fsFlip()">Flip</button>
                <button class="btn btn-secondary" onclick="app.fsRead()">Read</button>
            </div>
            <button class="btn btn-secondary" onclick="app.closeFS()">Close</button>
        </div>
        <div id="fsContent"></div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <strong>Settings</strong>
                <button class="btn btn-secondary" onclick="document.getElementById('settingsModal').style.display='none'">X</button>
            </div>
            <div class="modal-body">
                <div class="setting-row">
                    <label>Proxy URL</label>
                    <input type="text" id="proxyInput" placeholder="https://...">
                </div>
                <div class="setting-row">
                    <label>View</label>
                    <div class="toggle-group">
                        <button class="toggle-btn" onclick="app.setView('list')">List</button>
                        <button class="toggle-btn" onclick="app.setView('grid')">Grid</button>
                    </div>
                </div>
                <div class="setting-row">
                    <label>Theme Presets</label>
                    <div class="toggle-group">
                        <button class="toggle-btn" onclick="app.applyThemePreset('dracula')">Dracula</button>
                        <button class="toggle-btn" onclick="app.applyThemePreset('solarized')">Solarized</button>
                        <button class="toggle-btn" onclick="app.applyThemePreset('matrix')">Matrix</button>
                        <button class="toggle-btn" onclick="app.applyThemePreset('light')">Light</button>
                    </div>
                    <div style="margin-top:5px; display:flex; gap:5px;">
                        <button class="toggle-btn" onclick="app.toggleThemeMode()">Toggle</button>
                        <button class="toggle-btn" id="lockBtn" onclick="app.toggleThemeLock()">Lock</button>
                    </div>
                </div>
                <div class="setting-row">
                    <label>Data Management</label>
                    <div class="toggle-group">
                        <button class="toggle-btn" onclick="app.exportData()">Export</button>
                        <button class="toggle-btn" onclick="document.getElementById('importFile').click()">Import</button>
                    </div>
                    <input type="file" id="importFile" style="display:none" onchange="app.importData(this)">
                    <button class="btn-danger" onclick="app.clearAllCards()">Clear All Cards</button>
                    <br><br>
                    <button class="btn-danger" onclick="app.factoryReset()">Factory Reset</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="promptModal">
        <div class="modal">
            <div class="modal-header">
                <strong id="promptTitle">Action</strong>
                <button class="btn btn-secondary" onclick="document.getElementById('promptModal').style.display='none'">X</button>
            </div>
            <div class="modal-body">
                <textarea id="promptText"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('promptModal').style.display='none'">Cancel</button>
                <button class="btn btn-primary" onclick="app.confirmPrompt()">OK</button>
            </div>
        </div>
    </div>

    <div id="toast">Action</div>

    <script>
        class App {
            constructor() {
                const defaultState = {
                    cards: [],
                    theme: { name: "ai-Ncards", bg: "#121212", cardBg: "#1e1e1e", text: "#f5f5f5", border: "#333333", primary: "#c41e3a", lock: false },
                    settings: { proxy: "", view: "list" }
                };
                const saved = localStorage.getItem('ai_ncards_v1');
                if (saved) {
                    this.state = JSON.parse(saved);
                    // Merge defaults to ensure new fields exist
                    this.state.theme = { ...defaultState.theme, ...this.state.theme };
                    this.state.settings = { ...defaultState.settings, ...this.state.settings };
                    // Ensure cards array exists
                    if (!Array.isArray(this.state.cards)) this.state.cards = [];
                } else {
                    this.state = defaultState;
                }
                this.streamId = null;
                this.selected = new Set();
                this.menuTarget = null;
                this.fsId = null;
                this.fsFlipped = false;
                this.promptContext = null;
                this.history = [];
                this.decoder = new TextDecoder();
            }

            init() {
                this.applyTheme();
                this.render();
                this.bindEvents();
            }

            save() { 
                localStorage.setItem('ai_ncards_v1', JSON.stringify(this.state)); 
            }

            pushHistory(action) {
                if (this.history.length > 5) this.history.shift();
                this.history.push(JSON.parse(JSON.stringify(this.state)));
                this.showToast(action);
            }

            undo() {
                if (this.history.length === 0) return;
                this.state = this.history.pop();
                this.applyTheme();
                this.render();
                this.showToast("Undone");
            }

            showToast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            }

            // --- THEME LOGIC ---

            applyTheme() {
                const t = this.state.theme;
                const r = document.documentElement.style;
                r.setProperty('--bg', t.bg);
                r.setProperty('--card-bg', t.cardBg);
                r.setProperty('--text', t.text);
                r.setProperty('--border', t.border);
                r.setProperty('--primary', t.primary);
                document.getElementById('brandName').textContent = t.name || "ai-Ncards";
                
                document.body.className = '';
                if (this.state.settings.view === 'grid') document.body.classList.remove('view-list');
                else document.body.classList.add('view-list');

                const lockBtn = document.getElementById('lockBtn');
                if(lockBtn) lockBtn.textContent = t.lock ? "Unlock" : "Lock";
                if(lockBtn) lockBtn.classList.toggle('active', t.lock);
            }

            // Apply specific presets
            applyThemePreset(name) {
                if (this.state.theme.lock) { this.showToast("Theme Locked"); return; }
                
                const presets = {
                    'dracula': { bg: '#282a36', cardBg: '#44475a', text: '#f8f8f2', border: '#6272a4', primary: '#ff79c6', name: 'Dracula' },
                    'solarized': { bg: '#002b36', cardBg: '#073642', text: '#839496', border: '#586e75', primary: '#b58900', name: 'Solarized' },
                    'matrix': { bg: '#000000', cardBg: '#0d0d0d', text: '#00ff00', border: '#003300', primary: '#00ff00', name: 'Matrix' },
                    'light': { bg: '#f5f5f5', cardBg: '#ffffff', text: '#222222', border: '#e0e0e0', primary: '#d32f2f', name: 'Light' }
                };

                if (presets[name]) {
                    this.state.theme = { ...this.state.theme, ...presets[name], lock: false };
                    this.applyTheme();
                    this.save();
                    this.showToast("Applied: " + name);
                }
            }

            // Handle "Apply theme [Name]" from input
            forceApplyTheme(inputStr) {
                if (this.state.theme.lock) return false;

                const match = inputStr.toLowerCase().match(/apply theme (.+)/);
                if (!match) return false;

                const themeName = match[1].trim();
                
                // Check standard presets
                if (['dracula', 'solarized', 'matrix', 'light', 'dark'].includes(themeName)) {
                    this.applyThemePreset(themeName);
                    return true;
                }

                // Custom Hex creation (e.g., "apply theme #000000")
                if (themeName.startsWith('#')) {
                    this.state.theme.bg = themeName;
                    this.state.theme.cardBg = themeName;
                    this.state.theme.text = '#ffffff';
                    this.state.theme.border = '#444444';
                    this.state.theme.primary = '#ff0000';
                    this.state.theme.name = themeName;
                    this.applyTheme();
                    this.save();
                    this.showToast("Custom Theme: " + themeName);
                    return true;
                }
                
                // Colors
                if (['red', 'blue', 'green', 'purple', 'orange'].includes(themeName)) {
                    const colors = {
                        red: { bg: '#1a0000', cardBg: '#4d0000', text: '#ffcccc', border: '#990000', primary: '#ff3333' },
                        blue: { bg: '#00001a', cardBg: '#00004d', text: '#ccccff', border: '#000099', primary: '#3333ff' },
                        green: { bg: '#001a00', cardBg: '#004d00', text: '#ccffcc', border: '#009900', primary: '#33ff33' }
                    };
                    if (colors[themeName]) {
                        this.state.theme = { ...this.state.theme, ...colors[themeName], name: themeName.toUpperCase() };
                        this.applyTheme(); this.save(); return true;
                    }
                }
                return false;
            }

            toggleThemeMode() {
                if (this.state.theme.lock) { this.showToast("Theme Locked"); return; }
                const isDark = this.state.theme.bg === '#121212' || (parseInt(this.state.theme.bg.replace('#',''), 16) < 0x777777);
                if (isDark) {
                    // Light
                    this.state.theme = { ...this.state.theme, name: "Light Mode", bg: '#f8f9fa', cardBg: '#ffffff', text: '#222222', border: '#e0e0e0' };
                } else {
                    // Dark
                    this.state.theme = { ...this.state.theme, name: "Dark Mode", bg: '#121212', cardBg: '#1e1e1e', text: '#f5f5f5', border: '#333333' };
                }
                this.applyTheme(); this.save();
            }

            toggleThemeLock() {
                this.state.theme.lock = !this.state.theme.lock;
                this.applyTheme(); this.save();
                this.showToast(this.state.theme.lock ? "Theme Locked" : "Theme Unlocked");
            }

            // --- RENDER ---

            render() {
                const grid = document.getElementById('grid');
                if (this.state.cards.length === 0) {
                    grid.innerHTML = `<div style="text-align:center; padding-top:50px; color:var(--text); opacity:0.5; width:100%; grid-column: 1/-1;"><h3>Start Drafting</h3><p>Use "Apply theme [name]" in Input.<br>Double Click to Edit.</p></div>`;
                    return;
                }
                
                if (!this.isStreamingUpdate) grid.innerHTML = '';

                this.state.cards.forEach(c => {
                    let card = document.querySelector(`.flip-card[data-id="${c.id}"]`);
                    const mustRebuild = !card || card.innerHTML === "";

                    if (mustRebuild || !this.isStreamingUpdate) {
                        if (!card) {
                            card = document.createElement('div');
                            card.className = 'flip-card';
                            card.dataset.id = c.id;

                            // Click Events
                            card.addEventListener('click', (e) => {
                                if (e.target.closest('.card-actions')) return;
                                if (this.selected.size > 0) { this.toggleSelect(c.id, e); return; }
                                card.classList.toggle('flipped');
                            });

                            card.addEventListener('dblclick', (e) => {
                                const target = e.target.closest('.card-content');
                                if (!target) return;
                                e.stopPropagation();
                                const isFront = target.parentElement.dataset.face === 'front';
                                this.promptContext = { type: 'edit', id: c.id, target: isFront ? 'q' : 'r' };
                                this.showPromptModal(isFront ? "Edit Request" : "Edit Response", isFront ? c.q : c.r);
                            });

                            // Touch
                            let pressTimer;
                            card.addEventListener('touchstart', () => { pressTimer = setTimeout(() => this.openMenu(c.id), 500); });
                            card.addEventListener('touchend', () => clearTimeout(pressTimer));

                            grid.appendChild(card);
                        }

                        let contentBack = this.md(c.r);
                        // Visual "Thinking"
                        if (c.r === '...' && this.streamId === c.id) {
                            contentBack = `<span class="thinking">Thinking... <button class="stop-btn" onclick="app.stopStream()">STOP</button></span> <span class="cursor"></span>`;
                        }

                        card.innerHTML = `
                            <div class="flip-card-inner">
                                <div class="flip-card-face front" data-face="front">
                                    <div class="card-header">
                                        <span>REQUEST</span>
                                        <div class="card-actions">
                                            <i class="fas fa-check" onclick="app.toggleSelect('${c.id}', event)"></i>
                                            <i class="fas fa-ellipsis-h" onclick="app.openMenu('${c.id}', event)"></i>
                                        </div>
                                    </div>
                                    <div class="card-content">${this.md(c.q)}</div>
                                </div>
                                <div class="flip-card-face back" data-face="back">
                                    <div class="card-header">
                                        <span>RESPONSE</span>
                                        <div class="card-actions">
                                            <i class="fas fa-redo-alt" onclick="app.replay('${c.id}', event)" title="Replay"></i>
                                            <i class="fas fa-volume-up" onclick="app.speak('${c.id}', event)"></i>
                                            <i class="fas fa-ellipsis-h" onclick="app.openMenu('${c.id}', event)"></i>
                                        </div>
                                    </div>
                                    <div class="card-content">${contentBack}</div>
                                </div>
                            </div>
                        `;
                    }

                    // Styles
                    const f = card.querySelector('.front');
                    const b = card.querySelector('.back');
                    if (c.style) {
                        if (c.style.bg) { f.style.background = c.style.bg; b.style.background = c.style.bg; }
                        if (c.style.color) { f.style.color = c.style.color; b.style.color = c.style.color; }
                    }

                    // Selection
                    if (this.selected.has(c.id)) {
                        card.style.borderColor = 'var(--primary)';
                        card.style.boxShadow = '0 0 0 2px var(--primary)';
                    } else {
                        card.style.borderColor = 'var(--border)';
                        card.style.boxShadow = 'none';
                    }
                });

                // Bar
                const bar = document.getElementById('selectionBar');
                bar.style.display = this.selected.size > 0 ? 'flex' : 'none';
                if (this.selected.size > 0) document.getElementById('selectCount').textContent = this.selected.size;

                this.isStreamingUpdate = false;
            }

            // --- ACTIONS ---

            // Visual Replay
            replay(id, e) {
                if (e) e.stopPropagation();
                const card = this.state.cards.find(c => c.id === id);
                if (!card || !card.r || card.r === '...') return;

                const original = card.r;
                card.r = '...';
                this.isStreamingUpdate = true;
                this.render();

                let i = 0;
                const el = document.querySelector(`.flip-card[data-id="${id}"] .back .card-content`);
                
                const interval = setInterval(() => {
                    if (i < original.length) {
                        const chunk = original.substring(0, i + 1);
                        card.r = chunk;
                        if (el) {
                            el.innerHTML = this.md(chunk) + `<span class="cursor"></span>`;
                            el.scrollTop = el.scrollHeight;
                        }
                        if (this.fsId === id && document.getElementById('fullscreenOverlay').style.display === 'flex') {
                            const fs = document.getElementById('fsContent');
                            fs.innerHTML = this.md(chunk);
                            fs.scrollTop = fs.scrollHeight;
                        }
                        i++;
                    } else {
                        clearInterval(interval);
                        card.r = original;
                        this.isStreamingUpdate = true;
                        this.render();
                    }
                }, 20);
            }

            toggleSelect(id, e) {
                if (e) e.stopPropagation();
                if (this.selected.has(id)) this.selected.delete(id);
                else this.selected.add(id);
                this.render();
            }
            clearSelection() { this.selected.clear(); this.render(); }
            bulkDelete() {
                this.pushHistory("Bulk Delete");
                this.state.cards = this.state.cards.filter(c => !this.selected.has(c.id));
                this.selected.clear(); this.save(); this.render();
            }
            bulkMerge() {
                if (this.selected.size < 2) return this.showToast("Select 2+");
                const sel = this.state.cards.filter(c => this.selected.has(c.id));
                const combined = sel.map(c => `Topic: ${c.q}. Content: ${c.r}`).join('\n\n');
                const id = crypto.randomUUID();
                this.state.cards.push({ id, q: "Merged Topic", r: "...", style: {} });
                this.save(); this.render();
                // Auto Flip
                setTimeout(() => {
                    const el = document.querySelector(`.flip-card[data-id="${id}"]`);
                    if(el) el.classList.add('flipped');
                    document.getElementById('grid').scrollTop = document.getElementById('grid').scrollHeight;
                }, 100);
                this.sendRequest(`Merge these: ${combined}`, id);
                this.selected.clear();
            }

            openMenu(id, e) {
                if (e) e.stopPropagation();
                this.menuTarget = id;
                const menu = document.getElementById('cardMenu');
                let x = (e && e.clientX) || window.innerWidth / 2;
                let y = (e && e.clientY) || window.innerHeight / 2;
                if (x + 160 > window.innerWidth) x = window.innerWidth - 170;
                if (y + 200 > window.innerHeight) y = window.innerHeight - 210;
                menu.style.display = 'block'; menu.style.left = x + 'px'; menu.style.top = y + 'px';
            }

            speak(id, e) {
                if (e) e.stopPropagation();
                const card = this.state.cards.find(c => c.id === id);
                if (!card || !card.r || card.r === '...') return;
                const txt = card.r.replace(/[#*_`>~-]/g, '').substring(0, 2000);
                if (window.responsiveVoice && window.responsiveVoice.speak) {
                    if (window.responsiveVoice.isPlaying()) window.responsiveVoice.cancel();
                    else window.responsiveVoice.speak(txt, "US English Female", { rate: 1.1 });
                } else if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
                }
            }

            getProxy() {
                const val = document.getElementById('proxyInput')?.value.trim();
                if (val) { this.state.settings.proxy = val; this.save(); return val; }
                return this.state.settings.proxy || 'https://ai-proxy.ai-n.workers.dev/api/generate';
            }

            async sendRequest(prompt, targetId = null) {
                // 1. Check Input Commands
                if (this.forceApplyTheme(prompt)) return;

                const proxy = this.getProxy();
                
                // 2. Create Card if new
                if (!targetId) {
                    const id = crypto.randomUUID();
                    this.state.cards.push({ id, q: prompt, r: "...", style: {} });
                    targetId = id;
                    this.save(); 
                    this.render();
                    
                    // 3. Auto-Flip immediately to show response side
                    setTimeout(() => {
                        const el = document.querySelector(`.flip-card[data-id="${id}"]`);
                        if (el) {
                            el.classList.add('flipped');
                            el.scrollTop = el.scrollHeight;
                        }
                    }, 100);
                } else {
                    // Existing card update (like merge)
                    const card = this.state.cards.find(c => c.id === targetId);
                    if (card) card.r = "...";
                    this.render();
                }

                this.streamId = targetId;

                // 4. Send to AI with strict instructions
                const sysPrompt = `You are a visual AI assistant. 
                - Keep text concise. 
                - Use !theme:Name,Bg,CardBg,Text,Border,Primary! to change theme (Hex codes). 
                - Use !action:clear! to clear screen. 
                - Use !action:view:grid! or !action:view:list! to change layout. 
                - Use 'New Request: ...' to edit the top text. 
                - Use 'New Response: ...' to edit the bottom text.
                - Do NOT say "I am unable to create or modify themes". Just generate the command.`;

                try {
                    const response = await fetch(proxy, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: sysPrompt + "\n\nUser Request: " + prompt })
                    });
                    if (!response.ok) throw new Error("Proxy Error");
                    const reader = response.body.getReader();
                    let buffer = "", fullText = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        buffer += this.decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n\n');
                        buffer = lines.pop() || "";
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const jsonStr = line.substring(6);
                                if (jsonStr === '[DONE]') continue;
                                try {
                                    const json = JSON.parse(jsonStr);
                                    const chunk = json.choices?.[0]?.delta?.content;
                                    if (chunk) {
                                        fullText += chunk;
                                        this.updateStream(targetId, fullText);
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                    this.finalizeStream(targetId, fullText);
                } catch (err) {
                    const card = this.state.cards.find(c => c.id === targetId);
                    if (card) card.r = "Error: " + err.message;
                    this.streamId = null;
                    this.render();
                }
            }

            updateStream(id, text) {
                const card = this.state.cards.find(c => c.id === id);
                if (card) {
                    // Keep raw text, but UI strips for display
                    card.r = text; 
                    
                    // Visual Update (Strip commands for UI)
                    const cleanUI = text.replace(/!([^!]+)!/g, '').trim();
                    const displayText = cleanUI.length > 0 ? cleanUI : text; 

                    const el = document.querySelector(`.flip-card[data-id="${id}"] .back .card-content`);
                    if (el) { 
                        el.innerHTML = this.md(displayText) + (cleanUI.length > 0 ? `<span class="cursor"></span>` : ''); 
                        el.scrollTop = el.scrollHeight; 
                    }
                    
                    // Update FS
                    if (this.fsId === id && document.getElementById('fullscreenOverlay').style.display === 'flex') {
                        const fsEl = document.getElementById('fsContent');
                        fsEl.innerHTML = this.md(displayText);
                        fsEl.scrollTop = fsEl.scrollHeight;
                    }

                    // Grid Scroll
                    const grid = document.getElementById('grid');
                    if (grid.scrollTop + grid.clientHeight + 200 > grid.scrollHeight) grid.scrollTop = grid.scrollHeight;
                }
            }

            finalizeStream(id, text) {
                this.streamId = null;
                const card = this.state.cards.find(c => c.id === id);
                if (!card) return;

                let cleanText = text;
                
                // 1. Parse Theme Command
                const themeMatch = text.match(/!theme:([^!]+)!/);
                if (themeMatch && !this.state.theme.lock) {
                    const parts = themeMatch[1].split(',');
                    if (parts.length >= 6) {
                        const [n, b, cb, t, br, p] = parts.map(s => s.trim());
                        this.state.theme = { name: n, bg: b, cardBg: cb, text: t, border: br, primary: p, lock: false };
                        this.applyTheme();
                        this.showToast("Theme: " + n);
                    }
                    cleanText = cleanText.replace(themeMatch[0], '');
                }

                // 2. Actions
                if (text.includes('!action:view:grid!')) this.setView('grid');
                if (text.includes('!action:view:list!')) this.setView('list');
                if (text.includes('!action:clear!')) { this.state.cards = []; this.save(); this.render(); return; }

                // 3. Extract Content (New Request/Response)
                const newReq = cleanText.match(/New Request:\s*(.+)/i);
                const newRes = cleanText.match(/New Response:\s*(.+)/i);

                if (newReq) { card.q = newReq[1].trim(); cleanText = cleanText.replace(newReq[0], ''); }
                if (newRes) { card.r = newRes[1].trim(); cleanText = cleanText.replace(newReq[0], ''); } // Fix: Replace newRes
                
                // If not empty after stripping commands, update R
                const stripped = cleanText.replace(/!([^!]+)!/g, '').trim();
                
                // Logic: If AI generated content (not just commands), update R
                if (stripped.length > 0) {
                    // If we had a New Response command, we used that. Otherwise, use stripped text.
                    if (!newRes) {
                         // If card.r was '...' (placeholder), replace. Else append or replace.
                         card.r = stripped;
                    } else {
                        // If we had New Response, we already set it. But let's clean it just in case.
                        card.r = card.r.replace(/!([^!]+)!/g, '').trim();
                    }
                }

                this.save();
                this.render();
                this.showToast("Done");
            }

            stopStream() {
                this.streamId = null;
                this.render();
            }

            // --- MODALS ---

            showPromptModal(title, content) {
                document.getElementById('promptTitle').textContent = title;
                document.getElementById('promptText').value = content;
                document.getElementById('promptModal').style.display = 'flex';
                setTimeout(() => document.getElementById('promptText').focus(), 50);
            }

            confirmPrompt() {
                const val = document.getElementById('promptText').value.trim();
                if (!val) return;
                document.getElementById('promptModal').style.display = 'none';

                // Check for theme command in prompt modal
                if (this.forceApplyTheme(val)) return;

                if (this.promptContext?.type === 'edit') {
                    const card = this.state.cards.find(c => c.id === this.promptContext.id);
                    if (card) {
                        if (this.promptContext.target === 'q') card.q = val;
                        if (this.promptContext.target === 'r') card.r = val;
                        this.save(); this.render();
                    }
                } else if (this.promptContext?.type === 'rename') {
                    this.state.theme.name = val; this.applyTheme(); this.save();
                } else if (this.promptContext?.type === 'ai') {
                    const card = this.state.cards.find(c => c.id === this.promptContext.id);
                    if (card) this.sendRequest(`Change current content to: ${val}`, card.id);
                } else if (this.promptContext?.type === 'continue') {
                    const card = this.state.cards.find(c => c.id === this.promptContext.id);
                    if (card) this.sendRequest(`Continue: ${val}`, card.id);
                } else {
                    this.sendRequest(val);
                }
                this.promptContext = null;
            }

            openFS(id) {
                this.fsId = id; this.fsFlipped = false;
                const card = this.state.cards.find(c => c.id === id);
                if (!card) return;
                const cont = document.getElementById('fsContent');
                cont.innerHTML = this.md(card.r);
                document.getElementById('fullscreenOverlay').style.display = 'flex';
                setTimeout(() => { cont.scrollTop = cont.scrollHeight; }, 50);
            }

            closeFS() { 
                document.getElementById('fullscreenOverlay').style.display = 'none'; 
                this.fsId = null; 
            }

            fsFlip() {
                if (!this.fsId) return;
                const card = this.state.cards.find(c => c.id === this.fsId);
                const cont = document.getElementById('fsContent');
                this.fsFlipped = !this.fsFlipped;
                cont.innerHTML = this.md(this.fsFlipped ? card.q : card.r);
                cont.scrollTop = 0;
            }

            fsRead() { if (this.fsId) this.speak(this.fsId); }

            setView(view) {
                this.state.settings.view = view;
                this.save(); this.applyTheme();
                this.showToast(`View: ${view}`);
            }
            
            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state));
                const anchor = document.createElement('a');
                anchor.setAttribute("href", dataStr);
                anchor.setAttribute("download", "ai_ncards_export.json");
                document.body.appendChild(anchor);
                anchor.click(); anchor.remove();
            }
            
            importData(input) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.state = JSON.parse(e.target.result);
                        this.save(); this.applyTheme(); this.render(); this.showToast("Imported");
                        document.getElementById('settingsModal').style.display = 'none';
                    } catch { alert("Invalid JSON"); }
                };
                reader.readAsText(file);
            }
            
            clearAllCards() {
                if (confirm("Delete all cards?")) {
                    this.pushHistory("Clear All Cards");
                    this.state.cards = [];
                    this.save(); this.render();
                    document.getElementById('settingsModal').style.display = 'none';
                }
            }
            
            factoryReset() {
                if (confirm("Factory Reset: Wipe all data?")) {
                    localStorage.removeItem('ai_ncards_v1');
                    location.reload();
                }
            }

            md(text) {
                if (!text) return '';
                try { return DOMPurify.sanitize(marked.parse(text)); } catch { return text; }
            }

            bindEvents() {
                const input = document.getElementById('userInput');
                const send = () => { 
                    if (input.value.trim()) { 
                        this.sendRequest(input.value.trim()); 
                        input.value = ''; 
                    } 
                };
                input.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
                document.getElementById('sendBtn').onclick = send;

                document.getElementById('settingsBtn').onclick = () => {
                    document.getElementById('proxyInput').value = this.state.settings.proxy || '';
                    document.getElementById('settingsModal').style.display = 'flex';
                };
                document.getElementById('undoBtn').onclick = () => this.undo();
                document.getElementById('brandName').onclick = () => {
                    this.promptContext = { type: 'rename' };
                    this.showPromptModal("Rename Brand", this.state.theme.name);
                };

                document.getElementById('cardMenu').addEventListener('click', (e) => {
                    const act = e.target.dataset.act;
                    if (!act || !this.menuTarget) return;
                    document.getElementById('cardMenu').style.display = 'none';
                    const card = this.state.cards.find(c => c.id === this.menuTarget);

                    switch(act) {
                        case 'continue': this.promptContext = { type: 'continue', id: this.menuTarget }; this.showPromptModal("Continue", ""); break;
                        case 'ai-edit': this.promptContext = { type: 'ai', id: this.menuTarget }; this.showPromptModal("Magic Action", ""); break;
                        case 'style':
                            if (card) {
                                if (!card.style) card.style = {};
                                const bg = prompt("Background (hex/name):"); if(bg) card.style.bg = bg;
                                const col = prompt("Text Color:"); if(col) card.style.color = col;
                                this.save(); this.render();
                            } break;
                        case 'copy': navigator.clipboard.writeText(card.r); this.showToast("Copied"); break;
                        case 'fs': this.openFS(this.menuTarget); break;
                        case 'delete':
                            this.pushHistory("Delete");
                            this.state.cards = this.state.cards.filter(c => c.id !== this.menuTarget);
                            this.save(); this.render(); break;
                    }
                });

                window.onclick = (e) => {
                    if (e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
                    if (!e.target.closest('#cardMenu')) document.getElementById('cardMenu').style.display = 'none';
                };

                document.getElementById('grid').addEventListener('scroll', () => {
                    document.getElementById('cardMenu').style.display = 'none';
                });
            }
        }

        const app = new App();
        window.onload = () => app.init();
    </script>
</body>
</html>